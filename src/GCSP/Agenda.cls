Class GCSP.Agenda Extends %CSP.Page
{

ClassMethod OnPage() As %Status
{
    Set base = "/csp/mltest"
    Write "<!DOCTYPE html>"
    Write "<html lang=""es"">"
    Write "<head>"
    Write "<meta charset=""UTF-8"">"
    Write "<meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">"
    Write "<title>Agenda - IRIS105</title>"
    Write "<style>"
    Write ":root{--bg:#f5f8fc;--card:#fff;--b:#d6e0eb;--txt:#1d334a;--muted:#5f748b;--accent:#0f62fe;--accent2:#0a4cc4;--soft:#edf3fb;}"
    Write "*{box-sizing:border-box;}"
    Write "body{margin:0;background:var(--bg);font-family:Arial,sans-serif;color:var(--txt);}"
    Write ".wrap{max-width:1460px;margin:14px auto;padding:0 12px;}"
    Write ".card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:12px;margin-bottom:12px;}"
    Write ".head{display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap;}"
    Write ".head h1{margin:0;font-size:22px;}"
    Write ".toolbar{display:grid;grid-template-columns:repeat(8,minmax(120px,1fr));gap:10px;align-items:end;margin-top:10px;}"
    Write ".toolbar .span2{grid-column:span 2;}"
    Write ".label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px;}"
    Write "input,select,button{width:100%;padding:9px;border:1px solid #c5d4e5;border-radius:8px;background:#fff;color:var(--txt);font-size:14px;}"
    Write "button{border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;}"
    Write "button:hover{background:var(--accent2);}"
    Write "button.alt{background:var(--soft);border:1px solid #c3d3e6;color:#204060;}"
    Write "button.alt:hover{background:#e2ecf8;}"
    Write ".layout{display:grid;grid-template-columns:minmax(0,1fr) 320px;gap:12px;}"
    Write ".status{font-size:13px;color:var(--muted);margin-top:8px;}"
    Write ".status.err{color:#9f1f1f;}"
    Write ".legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;font-size:12px;color:#4d6782;}"
    Write ".legend span{padding:3px 8px;border-radius:999px;border:1px solid #c7d5e5;background:#fff;}"
    Write ".legend .l0{background:#eef2f7;border-color:#d5dee9;}"
    Write ".legend .l1{background:#e8f7ee;border-color:#bde8c9;}"
    Write ".legend .l2{background:#fff8e3;border-color:#f2dea6;}"
    Write ".legend .l3{background:#ffeede;border-color:#f7c998;}"
    Write ".legend .l4{background:#ffe3e3;border-color:#f0b7b7;}"
    Write ".weekday{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px;}"
    Write ".weekday div{background:#f0f5fb;border:1px solid #d6e0eb;border-radius:8px;padding:6px 8px;font-size:12px;font-weight:700;color:#2f4e6f;text-align:center;}"
    Write ".grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;}"
    Write ".day{min-height:140px;border:1px solid #d4dfeb;border-radius:10px;background:#fff;padding:6px;display:flex;flex-direction:column;}"
    Write ".day.off{background:#f9fbfe;color:#9db0c4;}"
    Write ".day-h{font-size:12px;font-weight:700;color:#315476;margin-bottom:6px;}"
    Write ".items{display:flex;flex-direction:column;gap:4px;}"
    Write ".slot{border:1px solid #c8d7e8;border-radius:8px;padding:6px;display:flex;flex-direction:column;gap:5px;}"
    Write ".slot-h{font-size:11px;font-weight:700;line-height:1.2;}"
    Write ".slot-items{display:flex;flex-direction:column;gap:4px;}"
    Write ".appt{display:block;width:100%;text-align:left;border:1px solid rgba(35,54,78,.18);background:rgba(255,255,255,.78);border-radius:7px;padding:5px 6px;font-size:12px;line-height:1.2;color:#173a66;}"
    Write ".appt:hover{background:#fff;}"
    Write ".appt .m{display:block;font-size:11px;opacity:.85;margin-top:2px;}"
    Write ".appt .risk{display:inline-block;margin-top:2px;padding:1px 5px;border-radius:999px;background:rgba(18,36,56,.1);font-size:10px;}"
    Write ".empty{font-size:11px;color:#8aa0b7;}"
    Write "pre{margin:0;min-height:640px;background:#0f172a;color:#d1fae5;border-radius:10px;padding:12px;overflow:auto;white-space:pre-wrap;word-break:break-word;}"
    Write ".side h3{margin:0 0 8px 0;}"
    Write "@media (max-width:1180px){.toolbar{grid-template-columns:repeat(4,minmax(120px,1fr));}.layout{grid-template-columns:1fr;}.side pre{min-height:180px;}}"
    Write "@media (max-width:740px){.toolbar{grid-template-columns:repeat(2,minmax(120px,1fr));}.head h1{font-size:19px;}.day{min-height:120px;}}"
    Write "</style>"
    Write "</head>"
    Write "<body>"
    Write "<div class=""wrap"">"
    Write "<div class=""card"">"
    Write "<div class=""head""><h1>Agenda de pacientes</h1><a id=""btnBack"" class=""alt"" style=""max-width:220px;text-align:center;text-decoration:none;padding-top:10px;display:block;"" href=""GCSP.Basic.cls"">Volver a GCSP.Basic</a></div>"
    Write "<div style=""margin-top:8px;font-size:12px;color:#5f748b;"">Vista Agenda v2 (sin dependencias externas de CDN).</div>"
    Write "<div class=""toolbar"">"
    Write "<div class=""span2""><label class=""label"">Base API</label><input id=""apiBase"" value="""_base_""" placeholder=""/csp/mltest""></div>"
    Write "<div class=""span2""><label class=""label"">Bearer Token</label><input id=""apiToken"" placeholder=""demo-readonly-token""></div>"
    Write "<div><label class=""label"">Vista</label><select id=""viewMode""><option value=""week"">Semana</option><option value=""month"">Mes</option></select></div>"
    Write "<div><label class=""label"">Fecha base</label><input id=""baseDate"" type=""date""></div>"
    Write "<div><label class=""label"">Especialidad</label><select id=""specialtyFilter""><option value="""">Todas</option></select></div>"
    Write "<div><label class=""label"">Medico</label><select id=""physicianFilter""><option value="""">Todos</option></select></div>"
    Write "<div class=""span2""><label class=""label"">Paciente (contiene)</label><input id=""patientFilter"" placeholder=""Nombre del paciente""></div>"
    Write "<div><button id=""btnPrev"" class=""alt"" type=""button"">Anterior</button></div>"
    Write "<div><button id=""btnToday"" class=""alt"" type=""button"">Hoy</button></div>"
    Write "<div><button id=""btnNext"" class=""alt"" type=""button"">Siguiente</button></div>"
    Write "<div><button id=""btnClear"" class=""alt"" type=""button"">Limpiar</button></div>"
    Write "</div>"
    Write "<div id=""statusLine"" class=""status"">Listo.</div>"
    Write "<div class=""legend""><span class=""l0"">Sin dato</span><span class=""l1"">NoShow 0%</span><span class=""l2"">NoShow 1-24%</span><span class=""l3"">NoShow 25-44%</span><span class=""l4"">NoShow >=45%</span></div>"
    Write "</div>"
    Write "<div class=""layout"">"
    Write "<div class=""card""><div class=""weekday""><div>Lun</div><div>Mar</div><div>Mie</div><div>Jue</div><div>Vie</div><div>Sab</div><div>Dom</div></div><div id=""agendaGrid"" class=""grid""><div class=""day""><div class=""day-h"">Cargando agenda...</div></div></div></div>"
    Write "<div class=""card side""><h3>Detalle de cita</h3><pre id=""detail"">Selecciona una cita en la agenda para ver detalle.</pre></div>"
    Write "</div>"
    Write "</div>"
    Write "<script>"
    Write "const defaultBase='"_base_"';"
    Write "const DAY_MS=86400000;"
    Write "let rawItems=[];"
    Write "function pad2(n){return String(n).padStart(2,'0');}"
    Write "function ymd(d){return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate());}"
    Write "function parseYmd(s){if(!s)return new Date();const p=String(s).split('-');if(p.length!==3)return new Date();return new Date(Number(p[0]),Number(p[1])-1,Number(p[2]));}"
    Write "function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}"
    Write "function startOfWeek(d){const x=new Date(d);const day=(x.getDay()+6)%7;x.setDate(x.getDate()-day);return x;}"
    Write "function endOfWeek(d){return addDays(startOfWeek(d),6);}"
    Write "function monthRange(base){const first=new Date(base.getFullYear(),base.getMonth(),1);const last=new Date(base.getFullYear(),base.getMonth()+1,0);return {start:startOfWeek(first),end:endOfWeek(last),month:first.getMonth()};}"
    Write "function weekRange(base){const s=startOfWeek(base);return {start:s,end:addDays(s,6),month:s.getMonth()};}"
    Write "function getMode(){return document.getElementById('viewMode').value;}"
    Write "function getBaseDate(){return parseYmd(document.getElementById('baseDate').value);}"
    Write "function setStatus(msg,isErr){const el=document.getElementById('statusLine');el.textContent=msg||'';el.className='status'+(isErr?' err':'');}"
    Write "function getBase(){const b=document.getElementById('apiBase').value.trim();return b||defaultBase;}"
    Write "function getToken(){return document.getElementById('apiToken').value.trim();}"
    Write "function debounce(fn,ms){let t=0;return function(){clearTimeout(t);t=setTimeout(fn,ms);};}"
    Write "async function callApi(path){const headers={};const t=getToken();if(t){headers.Authorization='Bearer '+t;}const r=await fetch(getBase()+path,{headers:headers});const tx=await r.text();let data={};try{data=tx?JSON.parse(tx):{};}catch(e){data={raw:tx};}if(!r.ok){throw new Error((data&&data.message)?data.message:('HTTP '+r.status));}return data;}"
    Write "function toDateFromTs(v){const s=String(v||'').replace(' ','T');const d=new Date(s);return isNaN(d.getTime())?new Date():d;}"
    Write "function timeLabel(v){const d=toDateFromTs(v);return pad2(d.getHours())+':'+pad2(d.getMinutes());}"
    Write "function noShowLabel(v){if(v==null||v==='')return 'N/D';const n=Number(v);if(isNaN(n))return String(v);return n>0?'1':'0';}"
    Write "function uniqBy(items,idKey,nameKey){const map={};items.forEach(function(it){const id=(it&&it[idKey]!=null)?String(it[idKey]):'';if(!id)return;if(!map[id])map[id]=String(it[nameKey]||id);});return Object.keys(map).map(function(k){return {value:k,label:map[k]};}).sort(function(a,b){return a.label.localeCompare(b.label);});}"
    Write "function refreshSelect(id,arr,allLabel){const sel=document.getElementById(id);const keep=sel.value;sel.innerHTML='';const o0=document.createElement('option');o0.value='';o0.textContent=allLabel;sel.appendChild(o0);arr.forEach(function(e){const o=document.createElement('option');o.value=e.value;o.textContent=e.label;sel.appendChild(o);});if(keep&&Array.from(sel.options).some(function(o){return o.value===keep;})){sel.value=keep;}}"
    Write "function updateFilterOptions(items){refreshSelect('specialtyFilter',uniqBy(items,'specialtyId','specialtyName'),'Todas');refreshSelect('physicianFilter',uniqBy(items,'physicianId','physicianName'),'Todos');}"
    Write "function applyFilters(items){const s=document.getElementById('specialtyFilter').value;const p=document.getElementById('physicianFilter').value;const q=(document.getElementById('patientFilter').value||'').trim().toLowerCase();return items.filter(function(it){if(s&&String(it.specialtyId)!==s)return false;if(p&&String(it.physicianId)!==p)return false;if(q&&String(it.patientName||'').toLowerCase().indexOf(q)<0)return false;return true;});}"
    Write "function showDetail(it){if(!it){document.getElementById('detail').textContent='Selecciona una cita en la agenda para ver detalle.';return;}const x=[];x.push('AppointmentId: '+(it.appointmentId||''));x.push('Paciente: '+(it.patientName||'')+' ('+(it.patientId||'')+')');x.push('Medico: '+(it.physicianName||'')+' ('+(it.physicianId||'')+')');x.push('Especialidad: '+(it.specialtyName||'')+' ('+(it.specialtyId||'')+')');x.push('Box: '+(it.boxName||'')+' ('+(it.boxId||'')+')');x.push('Inicio: '+(it.startDateTime||''));x.push('Fin: '+(it.endDateTime||''));x.push('NoShow: '+noShowLabel(it.noShow));document.getElementById('detail').textContent=x.join('\n');}"
    Write "function slotRisk(slotItems){let known=0;let noShow=0;slotItems.forEach(function(it){const n=Number(it.noShow);if(!isNaN(n)){known++;if(n>0)noShow++;}});const ratio=(known>0)?(noShow/known):0;return {known:known,noShow:noShow,ratio:ratio};}"
    Write "function riskTheme(rate,known){if(known===0)return {bg:'#eef2f7',border:'#d5dee9',text:'#45586f',label:'Sin dato'};if(rate>=0.45)return {bg:'#ffe3e3',border:'#e29b9b',text:'#7f1d1d',label:'Alto'};if(rate>=0.25)return {bg:'#ffeede',border:'#e8b383',text:'#7c3f00',label:'Medio'};if(rate>0)return {bg:'#fff8e3',border:'#e5cb7f',text:'#6f5300',label:'Bajo'};return {bg:'#e8f7ee',border:'#b4debf',text:'#155e32',label:'Muy bajo'};}"
    Write "function renderGrid(items,range,mode){const root=document.getElementById('agendaGrid');root.innerHTML='';const monthRef=getBaseDate().getMonth();const byDay={};items.forEach(function(it){const dt=toDateFromTs(it.startDateTime);const k=ymd(dt);const hour=pad2(dt.getHours());if(!byDay[k])byDay[k]={};if(!byDay[k][hour])byDay[k][hour]=[];byDay[k][hour].push(it);});let cursor=new Date(range.start);while(cursor<=range.end){const key=ymd(cursor);const day=document.createElement('div');day.className='day';if(mode==='month'&&cursor.getMonth()!==monthRef){day.className+=' off';}const h=document.createElement('div');h.className='day-h';h.textContent=key;day.appendChild(h);const box=document.createElement('div');box.className='items';const daySlots=byDay[key]||{};const slotKeys=Object.keys(daySlots).sort();if(slotKeys.length===0){const e=document.createElement('div');e.className='empty';e.textContent='Sin citas';box.appendChild(e);}else{slotKeys.forEach(function(slotKey){const slotItems=(daySlots[slotKey]||[]).slice().sort(function(a,b){return toDateFromTs(a.startDateTime)-toDateFromTs(b.startDateTime);});const risk=slotRisk(slotItems);const theme=riskTheme(risk.ratio,risk.known);const slot=document.createElement('div');slot.className='slot';slot.style.background=theme.bg;slot.style.borderColor=theme.border;slot.style.color=theme.text;const sh=document.createElement('div');sh.className='slot-h';if(risk.known>0){sh.textContent=slotKey+':00 | '+slotItems.length+' cita(s) | NoShow '+Math.round(risk.ratio*100)+'% ('+theme.label+')';}else{sh.textContent=slotKey+':00 | '+slotItems.length+' cita(s) | NoShow sin dato';}slot.appendChild(sh);const inner=document.createElement('div');inner.className='slot-items';slotItems.forEach(function(it){const btn=document.createElement('button');btn.type='button';btn.className='appt';btn.innerHTML=(it.patientName||'Paciente')+'<span class=""m"">'+(it.physicianName||'')+' / '+(it.specialtyName||'')+'</span><span class=""risk"">NoShow: '+noShowLabel(it.noShow)+'</span>';btn.addEventListener('click',function(){showDetail(it);});inner.appendChild(btn);});slot.appendChild(inner);box.appendChild(slot);});}day.appendChild(box);root.appendChild(day);cursor=addDays(cursor,1);}}"
    Write "function currentRange(){const base=getBaseDate();return (getMode()==='month')?monthRange(base):weekRange(base);}"
    Write "async function reload(){try{const range=currentRange();const limit=1000;const path='/api/ml/appointments/active?startDate='+encodeURIComponent(ymd(range.start))+'&endDate='+encodeURIComponent(ymd(range.end))+'&limit='+limit;const data=await callApi(path);rawItems=(data&&Array.isArray(data.items))?data.items:[];updateFilterOptions(rawItems);const filtered=applyFilters(rawItems);renderGrid(filtered,range,getMode());let msg='Rango '+ymd(range.start)+' a '+ymd(range.end)+' | Mostrando '+filtered.length+' de '+rawItems.length+' citas';if(rawItems.length>=limit)msg+=' (tope '+limit+')';setStatus(msg,false);}catch(ex){setStatus(String(ex),true);document.getElementById('agendaGrid').innerHTML='';}}"
    Write "const reloadDebounced=debounce(reload,180);"
    Write "function shiftBase(delta){const d=getBaseDate();if(getMode()==='month'){d.setMonth(d.getMonth()+delta);}else{d.setDate(d.getDate()+(delta*7));}document.getElementById('baseDate').value=ymd(d);reloadDebounced();}"
    Write "function initStorage(){const q=new URLSearchParams(window.location.search);const b=q.get('apiBase')||localStorage.getItem('iris105_api_base')||defaultBase;const t=q.get('token')||localStorage.getItem('iris105_api_token')||'demo-readonly-token';document.getElementById('apiBase').value=b;document.getElementById('apiToken').value=t;document.getElementById('baseDate').value=ymd(new Date());localStorage.setItem('iris105_api_base',b);localStorage.setItem('iris105_api_token',t);}"
    Write "function bindUi(){document.getElementById('apiBase').addEventListener('change',function(){localStorage.setItem('iris105_api_base',this.value.trim());reloadDebounced();});document.getElementById('apiToken').addEventListener('change',function(){localStorage.setItem('iris105_api_token',this.value.trim());reloadDebounced();});document.getElementById('viewMode').addEventListener('change',reloadDebounced);document.getElementById('baseDate').addEventListener('change',reloadDebounced);document.getElementById('specialtyFilter').addEventListener('change',reloadDebounced);document.getElementById('physicianFilter').addEventListener('change',reloadDebounced);document.getElementById('patientFilter').addEventListener('input',reloadDebounced);document.getElementById('btnToday').addEventListener('click',function(){document.getElementById('baseDate').value=ymd(new Date());reloadDebounced();});document.getElementById('btnPrev').addEventListener('click',function(){shiftBase(-1);});document.getElementById('btnNext').addEventListener('click',function(){shiftBase(1);});document.getElementById('btnClear').addEventListener('click',function(){document.getElementById('specialtyFilter').value='';document.getElementById('physicianFilter').value='';document.getElementById('patientFilter').value='';reloadDebounced();});}"
    Write "window.addEventListener('error',function(e){setStatus('Error JS: '+(e&&e.message?e.message:'desconocido'),true);});"
    Write "initStorage();bindUi();reload();"
    Write "</script>"
    Write "</body></html>"
    Quit $$$OK
}

}
