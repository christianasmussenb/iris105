Class GCSP.Basic Extends %CSP.Page
{

ClassMethod OnPage() As %Status
{
    Set base = "/csp/mltest"
    Write "<!DOCTYPE html>"
    Write "<html lang=""es"">"
    Write "<head>"
    Write "<meta charset=""UTF-8"">"
    Write "<title>NoShow Demo</title>"
    Write "<style>"
    Write "body{font-family:Arial, sans-serif;max-width:960px;margin:20px auto;padding:0 16px;background:#f7f7f7;color:#222;}"
    Write ".card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,0.05);}"
    Write ".row{display:flex;gap:12px;flex-wrap:wrap;}"
    Write ".row .card{flex:1;min-width:250px;}"
    Write "button{background:#0f62fe;color:#fff;border:none;border-radius:6px;padding:10px 14px;cursor:pointer;font-weight:600;}"
    Write "button:hover{background:#0d53d9;}"
    Write ".step-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;}"
    Write ".step-buttons button{min-width:42px;padding:8px 10px;}"
    Write ".step-buttons button.active{background:#083ea7;}"
    Write "input, select{padding:8px;border:1px solid #ccc;border-radius:6px;width:100%;box-sizing:border-box;}"
    Write ".label{font-size:12px;color:#555;margin-bottom:4px;display:block;}"
    Write "pre{background:#111;color:#0f0;padding:12px;border-radius:6px;overflow:auto;white-space:pre-wrap;word-break:break-word;min-height:96px;}"
    Write "</style>"
    Write "</head>"
    Write "<body>"
    Write "<h1>NoShowModel2 - Demo rápida</h1>"

    Write "<div class=""card"">"
    Write "<h3>Conexión API</h3>"
    Write "<div class=""row"">"
    Write "<div style=""flex:1;min-width:220px;""><label class=""label"">Base API</label><input id=""apiBase"" value="""_base_""" placeholder=""/csp/mltest""></div>"
    Write "<div style=""flex:1;min-width:220px;""><label class=""label"">Bearer Token</label><input id=""apiToken"" placeholder=""demo-readonly-token""></div>"
    Write "</div>"
    Write "</div>"

    Write "<div class=""card"">"
    Write "<h3>Entrenamiento SQL (paso a paso)</h3>"
    Write "<div class=""step-buttons"">"
    Write "<button id=""btnSql1"" data-step=""1"" type=""button"">1</button>"
    Write "<button id=""btnSql2"" data-step=""2"" type=""button"">2</button>"
    Write "<button id=""btnSql3"" data-step=""3"" type=""button"">3</button>"
    Write "<button id=""btnSql4"" data-step=""4"" type=""button"">4</button>"
    Write "<button id=""btnSql5"" data-step=""5"" type=""button"">5</button>"
    Write "<button id=""btnSql6"" data-step=""6"" type=""button"">6</button>"
    Write "</div>"
    Write "<label class=""label"" id=""sqlStepTitle"">Paso 1: Verificar modelo</label>"
    Write "<pre id=""sqlStepOutput"">Selecciona un paso para ver el SQL.</pre>"
    Write "<button id=""btnSqlSubmit"" type=""button"">Submit</button>"
    Write "<pre id=""sqlStepResult"">Resultados: sin ejecución.</pre>"
    Write "</div>"
    
    Write "<div class=""card"">"
    Write "<h3>Estadísticas</h3>"
    Write "<button id=""btnStats"" type=""button"">Ver estadísticas</button>"
    Write "<pre id=""stats"">Esperando...</pre>"
    Write "</div>"
    
    Write "<div class=""row"">"
    Write "<div class=""card"">"
    Write "<h3>Score por AppointmentId</h3>"
    Write "<label class=""label"">AppointmentId</label>"
    Write "<input id=""apptId"" placeholder=""APPT-12"">"
    Write "<button id=""btnScoreAppt"" type=""button"" style=""margin-top:8px;"">Calcular NoShow</button>"
    Write "<pre id=""scoreAppt"">Esperando...</pre>"
    Write "</div>"
    
    Write "<div class=""card"">"
    Write "<h3>Score por PatientId (última cita)</h3>"
    Write "<label class=""label"">PatientId</label>"
    Write "<input id=""patientId"" placeholder=""PAT-01"">"
    Write "<button id=""btnScorePatient"" type=""button"" style=""margin-top:8px;"">Calcular NoShow</button>"
    Write "<pre id=""scorePatient"">Esperando...</pre>"
    Write "</div>"
    Write "</div>"
    
    Write "<div class=""card"">"
    Write "<h3>Generar datos mock</h3>"
    Write "<div class=""row"">"
    Write "<div style=""flex:1;min-width:150px;""><label class=""label"">Meses</label><input id=""months"" type=""number"" min=""1"" max=""12"" placeholder=""3""></div>"
    Write "<div style=""flex:1;min-width:150px;""><label class=""label"">Occupancy (0-1)</label><input id=""occupancy"" type=""number"" step=""0.05"" min=""0"" max=""1"" placeholder=""0.85""></div>"
    Write "<div style=""flex:1;min-width:150px;""><label class=""label"">Pacientes</label><input id=""patients"" type=""number"" min=""10"" max=""10000"" placeholder=""100""></div>"
    Write "</div>"
    Write "<button id=""btnMock"" type=""button"" style=""margin-top:8px;"">Generar</button>"
    Write "<pre id=""mockResult"">Esperando...</pre>"
    Write "</div>"

    Write "<div class=""card"">"
    Write "<h3>Información del modelo (runs y métricas)</h3>"
    Write "<label class=""label"">ModelName (opcional)</label>"
    Write "<input id=""modelName"" placeholder=""NoShowModel2"">"
    Write "<button id=""btnModel"" type=""button"" style=""margin-top:8px;"">Ver info del modelo</button>"
    Write "<pre id=""modelInfo"">Esperando...</pre>"
    Write "</div>"
    
    Write "<script>"
    Write "const base='"_base_"';"
    Write "function getBase(){const b=document.getElementById('apiBase').value.trim();return b||base;}"
    Write "function getToken(){const t=document.getElementById('apiToken').value.trim();return t;}"
    Write "function pretty(el,data){try{el.textContent=JSON.stringify(data,null,2);}catch(e){el.textContent=data;}}"
    Write "async function callApi(path,opts){const options=opts||{};const headers=options.headers||{};const token=getToken();if(token){headers.Authorization='Bearer '+token;}if(options.body&&!headers['Content-Type']){headers['Content-Type']='application/json';}options.headers=headers;const out={};out.url=getBase()+path;try{const r=await fetch(out.url,options);out.status=r.status;const text=await r.text();try{out.data=text?JSON.parse(text):{};}catch(e){out.data={raw:text};}out.ok=r.ok;}catch(ex){out.ok=false;out.status=0;out.data={error:1,message:String(ex)};}return out;}"
    Write "async function loadStats(){const el=document.getElementById('stats');el.textContent='Consultando...';const res=await callApi('/api/ml/stats/summary');pretty(el,res);}"
    Write "async function scoreAppointment(){const id=document.getElementById('apptId').value;const el=document.getElementById('scoreAppt');el.textContent='Consultando...';const res=await callApi('/api/ml/noshow/score',{method:'POST',body:JSON.stringify({appointmentId:id})});pretty(el,res);}"
    Write "async function scoreLastPatient(){const pid=document.getElementById('patientId').value;const el=document.getElementById('scorePatient');if(!pid){el.textContent='Debe indicar PatientId';return;}el.textContent='Consultando...';const qs='?patientId='+encodeURIComponent(pid);const res=await callApi('/api/ml/stats/lastAppointmentByPatient'+qs);pretty(el,res);}"
    Write "async function generateMock(){const el=document.getElementById('mockResult');const months=document.getElementById('months').value;const occupancy=document.getElementById('occupancy').value;const patients=document.getElementById('patients').value;const payload={};if(months)payload.months=+months;if(occupancy)payload.targetOccupancy=+occupancy;if(patients)payload.patients=+patients;el.textContent='Consultando...';const res=await callApi('/api/ml/mock/generate',{method:'POST',body:JSON.stringify(payload)});pretty(el,res);}"
    Write "async function loadModel(){const el=document.getElementById('modelInfo');const m=document.getElementById('modelName').value;const qs=m?'?modelName='+encodeURIComponent(m):'';el.textContent='Consultando...';const res=await callApi('/api/ml/stats/model'+qs);pretty(el,res);}"
    Write "const sqlStep1=`SELECT MODEL_NAME, DEFAULT_TRAINED_MODEL_NAME, CREATE_TIMESTAMP\nFROM INFORMATION_SCHEMA.ML_MODELS\nWHERE MODEL_NAME='NoShowModel2';`;"
    Write "const sqlStep2=`CREATE MODEL NoShowModel2\nPREDICTING (NoShow)\nWITH (\n  PatientId INTEGER,\n  PhysicianId INTEGER,\n  BoxId INTEGER,\n  SpecialtyId INTEGER,\n  StartDateTime TIMESTAMP,\n  BookingChannel VARCHAR(50),\n  BookingDaysInAdvance INTEGER,\n  HasSMSReminder BOOLEAN,\n  Reason VARCHAR(200)\n)\nFROM IRIS105.Appointment;`;"
    Write "const sqlStep3=`TRAIN MODEL NoShowModel2\nUSING {\n  ""seed"": 42,\n  ""TrainMode"": ""BALANCE"",\n  ""MaxTime"": 60,\n  ""MinimumDesiredScore"": 0.80\n};`;"
    Write "const sqlStep4=`VALIDATE MODEL NoShowModel2;`;"
    Write "const sqlStep5=`SELECT MODEL_NAME, DESCRIPTION, PREDICTING_COLUMN_NAME, PREDICTING_COLUMN_TYPE, WITH_COLUMNS, CREATE_TIMESTAMP, DEFAULT_TRAINED_MODEL_NAME\nFROM INFORMATION_SCHEMA.ML_MODELS\nWHERE MODEL_NAME='NoShowModel2';\n\nSELECT METRIC_NAME, METRIC_VALUE, TRAINED_MODEL_NAME\nFROM INFORMATION_SCHEMA.ML_VALIDATION_METRICS\nWHERE MODEL_NAME='NoShowModel2';`;"
    Write "const sqlStep6=`SELECT TOP 10\n  A.AppointmentId,\n  PREDICT(NoShowModel2) AS PredictedLabel,\n  PROBABILITY(NoShowModel2 FOR 1) AS NoShowProb\nFROM IRIS105.Appointment A\nORDER BY A.StartDateTime DESC;`;"
    Write "let selectedSqlStep=1;"
    Write "function showSqlStep(step){const title=document.getElementById('sqlStepTitle');const out=document.getElementById('sqlStepOutput');const result=document.getElementById('sqlStepResult');let sql='';selectedSqlStep=step;if(step===1){title.textContent='Paso 1: Verificar modelo';sql=sqlStep1;}else if(step===2){title.textContent='Paso 2: Crear modelo (si no existe)';sql=sqlStep2;}else if(step===3){title.textContent='Paso 3: Entrenar modelo';sql=sqlStep3;}else if(step===4){title.textContent='Paso 4: Validar modelo';sql=sqlStep4;}else if(step===5){title.textContent='Paso 5: Revisar estado y métricas';sql=sqlStep5;}else if(step===6){title.textContent='Paso 6: Predicción SQL';sql=sqlStep6;}out.textContent=sql;result.textContent='Resultados: sin ejecución.';document.querySelectorAll('.step-buttons button').forEach((btn)=>{btn.classList.toggle('active',Number(btn.dataset.step)===step);});}"
    Write "async function runSqlStep(){const el=document.getElementById('sqlStepResult');el.textContent='Ejecutando paso '+selectedSqlStep+'...';const res=await callApi('/api/ml/model/step/execute',{method:'POST',body:JSON.stringify({step:selectedSqlStep})});pretty(el,res);}"
    Write "document.getElementById('btnStats').addEventListener('click',loadStats);"
    Write "document.getElementById('btnScoreAppt').addEventListener('click',scoreAppointment);"
    Write "document.getElementById('btnScorePatient').addEventListener('click',scoreLastPatient);"
    Write "document.getElementById('btnMock').addEventListener('click',generateMock);"
    Write "document.getElementById('btnModel').addEventListener('click',loadModel);"
    Write "document.getElementById('btnSql1').addEventListener('click',function(){showSqlStep(1);});"
    Write "document.getElementById('btnSql2').addEventListener('click',function(){showSqlStep(2);});"
    Write "document.getElementById('btnSql3').addEventListener('click',function(){showSqlStep(3);});"
    Write "document.getElementById('btnSql4').addEventListener('click',function(){showSqlStep(4);});"
    Write "document.getElementById('btnSql5').addEventListener('click',function(){showSqlStep(5);});"
    Write "document.getElementById('btnSql6').addEventListener('click',function(){showSqlStep(6);});"
    Write "document.getElementById('btnSqlSubmit').addEventListener('click',runSqlStep);"
    Write "const tokenInput=document.getElementById('apiToken');const saved=localStorage.getItem('iris105_api_token');tokenInput.value=saved||'demo-readonly-token';tokenInput.addEventListener('change',function(){localStorage.setItem('iris105_api_token',tokenInput.value.trim());});"
    Write "showSqlStep(1);"
    Write "</script>"
    Write "</body></html>"
    Quit $$$OK
}

}
