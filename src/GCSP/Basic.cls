Class GCSP.Basic Extends %CSP.Page
{

ClassMethod OnPage() As %Status
{
    Set base = "/csp/mltest"
    Write "<!DOCTYPE html>"
    Write "<html lang=""es"">"
    Write "<head>"
    Write "<meta charset=""UTF-8"">"
    Write "<title>NoShow Demo</title>"
    Write "<style>"
    Write "body{font-family:Arial, sans-serif;max-width:960px;margin:20px auto;padding:0 16px;background:#f7f7f7;color:#222;}"
    Write ".card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,0.05);}"
    Write ".row{display:flex;gap:12px;flex-wrap:wrap;}"
    Write ".row .card{flex:1;min-width:250px;}"
    Write "button{background:#0f62fe;color:#fff;border:none;border-radius:6px;padding:10px 14px;cursor:pointer;font-weight:600;}"
    Write "button:hover{background:#0d53d9;}"
    Write "input, select{padding:8px;border:1px solid #ccc;border-radius:6px;width:100%;box-sizing:border-box;}"
    Write ".label{font-size:12px;color:#555;margin-bottom:4px;display:block;}"
    Write "pre{background:#111;color:#0f0;padding:12px;border-radius:6px;overflow:auto;white-space:pre-wrap;word-break:break-word;min-height:96px;}"
    Write "</style>"
    Write "</head>"
    Write "<body>"
    Write "<h1>NoShowModel2 - Demo rápida</h1>"

    Write "<div class=""card"">"
    Write "<h3>Conexión API</h3>"
    Write "<div class=""row"">"
    Write "<div style=""flex:1;min-width:220px;""><label class=""label"">Base API</label><input id=""apiBase"" value="""_base_""" placeholder=""/csp/mltest""></div>"
    Write "<div style=""flex:1;min-width:220px;""><label class=""label"">Bearer Token</label><input id=""apiToken"" placeholder=""demo-readonly-token""></div>"
    Write "</div>"
    Write "</div>"
    
    Write "<div class=""card"">"
    Write "<h3>Estadísticas</h3>"
    Write "<button id=""btnStats"" type=""button"">Ver estadísticas</button>"
    Write "<pre id=""stats"">Esperando...</pre>"
    Write "</div>"
    
    Write "<div class=""row"">"
    Write "<div class=""card"">"
    Write "<h3>Score por AppointmentId</h3>"
    Write "<label class=""label"">AppointmentId</label>"
    Write "<input id=""apptId"" placeholder=""APPT-12"">"
    Write "<button id=""btnScoreAppt"" type=""button"" style=""margin-top:8px;"">Calcular NoShow</button>"
    Write "<pre id=""scoreAppt"">Esperando...</pre>"
    Write "</div>"
    
    Write "<div class=""card"">"
    Write "<h3>Score por PatientId (última cita)</h3>"
    Write "<label class=""label"">PatientId</label>"
    Write "<input id=""patientId"" placeholder=""PAT-01"">"
    Write "<button id=""btnScorePatient"" type=""button"" style=""margin-top:8px;"">Calcular NoShow</button>"
    Write "<pre id=""scorePatient"">Esperando...</pre>"
    Write "</div>"
    Write "</div>"
    
    Write "<div class=""card"">"
    Write "<h3>Generar datos mock</h3>"
    Write "<div class=""row"">"
    Write "<div style=""flex:1;min-width:150px;""><label class=""label"">Meses</label><input id=""months"" type=""number"" min=""1"" max=""12"" placeholder=""3""></div>"
    Write "<div style=""flex:1;min-width:150px;""><label class=""label"">Occupancy (0-1)</label><input id=""occupancy"" type=""number"" step=""0.05"" min=""0"" max=""1"" placeholder=""0.85""></div>"
    Write "<div style=""flex:1;min-width:150px;""><label class=""label"">Pacientes</label><input id=""patients"" type=""number"" min=""10"" max=""10000"" placeholder=""100""></div>"
    Write "</div>"
    Write "<button id=""btnMock"" type=""button"" style=""margin-top:8px;"">Generar</button>"
    Write "<pre id=""mockResult"">Esperando...</pre>"
    Write "</div>"

    Write "<div class=""card"">"
    Write "<h3>Información del modelo (runs y métricas)</h3>"
    Write "<label class=""label"">ModelName (opcional)</label>"
    Write "<input id=""modelName"" placeholder=""NoShowModel2"">"
    Write "<button id=""btnModel"" type=""button"" style=""margin-top:8px;"">Ver info del modelo</button>"
    Write "<pre id=""modelInfo"">Esperando...</pre>"
    Write "</div>"
    
    Write "<script>"
    Write "const base='"_base_"';"
    Write "function getBase(){const b=document.getElementById('apiBase').value.trim();return b||base;}"
    Write "function getToken(){const t=document.getElementById('apiToken').value.trim();return t;}"
    Write "function pretty(el,data){try{el.textContent=JSON.stringify(data,null,2);}catch(e){el.textContent=data;}}"
    Write "async function callApi(path,opts){const options=opts||{};const headers=options.headers||{};const token=getToken();if(token){headers.Authorization='Bearer '+token;}if(options.body&&!headers['Content-Type']){headers['Content-Type']='application/json';}options.headers=headers;const out={};out.url=getBase()+path;try{const r=await fetch(out.url,options);out.status=r.status;const text=await r.text();try{out.data=text?JSON.parse(text):{};}catch(e){out.data={raw:text};}out.ok=r.ok;}catch(ex){out.ok=false;out.status=0;out.data={error:1,message:String(ex)};}return out;}"
    Write "async function loadStats(){const el=document.getElementById('stats');el.textContent='Consultando...';const res=await callApi('/api/ml/stats/summary');pretty(el,res);}"
    Write "async function scoreAppointment(){const id=document.getElementById('apptId').value;const el=document.getElementById('scoreAppt');el.textContent='Consultando...';const res=await callApi('/api/ml/noshow/score',{method:'POST',body:JSON.stringify({appointmentId:id})});pretty(el,res);}"
    Write "async function scoreLastPatient(){const pid=document.getElementById('patientId').value;const el=document.getElementById('scorePatient');if(!pid){el.textContent='Debe indicar PatientId';return;}el.textContent='Consultando...';const qs='?patientId='+encodeURIComponent(pid);const res=await callApi('/api/ml/stats/lastAppointmentByPatient'+qs);pretty(el,res);}"
    Write "async function generateMock(){const el=document.getElementById('mockResult');const months=document.getElementById('months').value;const occupancy=document.getElementById('occupancy').value;const patients=document.getElementById('patients').value;const payload={};if(months)payload.months=+months;if(occupancy)payload.targetOccupancy=+occupancy;if(patients)payload.patients=+patients;el.textContent='Consultando...';const res=await callApi('/api/ml/mock/generate',{method:'POST',body:JSON.stringify(payload)});pretty(el,res);}"
    Write "async function loadModel(){const el=document.getElementById('modelInfo');const m=document.getElementById('modelName').value;const qs=m?'?modelName='+encodeURIComponent(m):'';el.textContent='Consultando...';const res=await callApi('/api/ml/stats/model'+qs);pretty(el,res);}"
    Write "document.getElementById('btnStats').addEventListener('click',loadStats);"
    Write "document.getElementById('btnScoreAppt').addEventListener('click',scoreAppointment);"
    Write "document.getElementById('btnScorePatient').addEventListener('click',scoreLastPatient);"
    Write "document.getElementById('btnMock').addEventListener('click',generateMock);"
    Write "document.getElementById('btnModel').addEventListener('click',loadModel);"
    Write "const tokenInput=document.getElementById('apiToken');const saved=localStorage.getItem('iris105_api_token');tokenInput.value=saved||'demo-readonly-token';tokenInput.addEventListener('change',function(){localStorage.setItem('iris105_api_token',tokenInput.value.trim());});"
    Write "</script>"
    Write "</body></html>"
    Quit $$$OK
}

}
